version: "3.8"
name: comtrans
services:

  db:
    image: postgres:13-alpine
    container_name: ctdb
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db/scripts:/docker-entrypoint-initdb.d
      - ./db/datasets:/datasets
    ports:
      - 6543:5432
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: users
    healthcheck:
      test: pg_isready -U postgres -d events
      interval: 1s
      timeout: 500ms
      start_period: 0s
      retries: 3
    restart: unless-stopped

  app:
    build: ./backend
    container_name: ctback
    ports:
      - 8080:8080
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      db:
        condition: service_healthy

  userservice:
  #  image: userservice
  #  image: ${DOCKER_REGISTRY-}userservice:latest
   image: userservice:latest
   container_name: userservice
  #  build:
  #   context: ./services/user/UserMicroservice
  #   dockerfile: Dockerfile
  #  build: ./services/user/UserMicroservice
   environment:
    - CONNECTIONSTRINGS__DEFAULTCONNECTION=Data Source=192.168.0.109,1433;Initial Catalog=UserServiceDB;User Id=******;Password=******
   ports:
    - "8080:80"

  ctwebui:
    build: ./client/ctwebclient
    container_name: ctwebui
    ports:
      - 5000:80
    # links:
      # - app

volumes:
  db-data:
